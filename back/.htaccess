# Activer le moteur de réécriture
RewriteEngine On

# Définir la base des URL
RewriteBase /

# Désactivation de l'affichage des erreurs
php_flag display_errors off
php_value error_reporting E_ALL
php_flag log_errors on
php_value error_log "../logs/php_errors.log"

# Définir les en-têtes CORS pour toutes les requêtes
<IfModule mod_headers.c>
    Header always set Access-Control-Allow-Origin "https://app-frontend-esgi-app.azurewebsites.net"
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
    Header always set Access-Control-Allow-Credentials "true"
    
    # Gérer les requêtes OPTIONS préliminaires CORS
    <If "%{REQUEST_METHOD} == 'OPTIONS'">
        Header always set Access-Control-Max-Age "1728000"
        Header always set Content-Type "text/plain charset=UTF-8"
        Header always set Content-Length "0"
        Header always set Status "204"
        Header always set Access-Control-Allow-Origin "https://app-frontend-esgi-app.azurewebsites.net"
        Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
        Header always set Access-Control-Allow-Credentials "true"
    </If>
</IfModule>

# Règle spéciale pour les requêtes OPTIONS (CORS)
RewriteCond %{REQUEST_METHOD} OPTIONS
RewriteRule ^(.*)$ $1 [R=200,L]

# Ne pas rediriger les fichiers/dossiers existants (php directs)
RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]

# Rediriger toutes les autres requêtes vers index.php (notre routeur)
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ index.php [QSA,L]

# Désactivation de l'affichage du contenu des répertoires
Options -Indexes

# Protection des fichiers sensibles
<FilesMatch "^(config\.php|\.htaccess|\.env)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# Empêcher l'accès aux dossiers et fichiers sensibles
<FilesMatch "^\.">
    Order allow,deny
    Deny from all
</FilesMatch>

<FilesMatch "\.(sql|log|ini|json)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# Forcer le type de contenu JSON pour l'API
<FilesMatch "api\.php$">
    ForceType application/json
    Header set Content-Type "application/json"
</FilesMatch>

# Base pour les routes API
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ routes/api.php [QSA,L]

# Gestion des erreurs
ErrorDocument 500 "{\"success\":false,\"message\":\"Erreur serveur interne\"}"
ErrorDocument 404 "{\"success\":false,\"message\":\"Route non trouvée\"}"
ErrorDocument 403 "{\"success\":false,\"message\":\"Accès non autorisé\"}"

# Endpoints de statut du serveur
RewriteRule ^api/status$ status.php [L]
RewriteRule ^api/db-status$ status.php?type=db [L]

# Rediriger les requêtes API vers le contrôleur appropié
RewriteRule ^api/classes/?$ routes/api.php?resource=classes [QSA,L]
RewriteRule ^api/classes/([0-9]+)/?$ routes/api.php?resource=classes&id=$1 [QSA,L]

RewriteRule ^api/matieres/?$ routes/api.php?resource=matieres [QSA,L]
RewriteRule ^api/matieres/([0-9]+)/?$ routes/api.php?resource=matieres&id=$1 [QSA,L]

RewriteRule ^api/examens/?$ routes/api.php?resource=examens [QSA,L]
RewriteRule ^api/examens/([0-9]+)/?$ routes/api.php?resource=examens&id=$1 [QSA,L]

RewriteRule ^api/notes/?$ routes/api.php?resource=notes [QSA,L]
RewriteRule ^api/notes/([0-9]+)/?$ routes/api.php?resource=notes&id=$1 [QSA,L]
RewriteRule ^api/notes/exam/([0-9]+)/?$ routes/api.php?resource=notes&exam=$1 [QSA,L]

RewriteRule ^api/users/?$ routes/api.php?resource=users [QSA,L]
RewriteRule ^api/users/([0-9]+)/?$ routes/api.php?resource=users&id=$1 [QSA,L]
RewriteRule ^api/users/classe/([0-9]+)/?$ routes/api.php?resource=users&classe=$1 [QSA,L]

RewriteRule ^api/auth/login$ routes/api.php?resource=auth&action=login [QSA,L]
RewriteRule ^api/auth/logout$ routes/api.php?resource=auth&action=logout [QSA,L]
RewriteRule ^api/auth/status$ routes/api.php?resource=auth&action=status [QSA,L]

RewriteRule ^api/profs/?$ routes/api.php?resource=profs [QSA,L]
RewriteRule ^api/profs/([0-9]+)/?$ routes/api.php?resource=profs&id=$1 [QSA,L] 