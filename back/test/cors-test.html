<!DOCTYPE html>
<html lang="fr">
	<head>
		<meta charset="UTF-8" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1.0" />
		<title>CORS Test Backend</title>
		<style>
			body {
				font-family: Arial, sans-serif;
				max-width: 800px;
				margin: 0 auto;
				padding: 20px;
				line-height: 1.6;
			}
			h1,
			h2 {
				color: #0078d7;
			}
			button {
				background-color: #0078d7;
				color: white;
				border: none;
				padding: 10px 15px;
				margin: 5px;
				cursor: pointer;
				border-radius: 4px;
			}
			button:hover {
				background-color: #005a9e;
			}
			pre {
				background-color: #f5f5f5;
				padding: 10px;
				border-radius: 4px;
				overflow-x: auto;
			}
			.success {
				color: green;
				font-weight: bold;
			}
			.error {
				color: red;
				font-weight: bold;
			}
			.result {
				margin-top: 20px;
				border: 1px solid #ddd;
				padding: 15px;
				border-radius: 4px;
				background-color: #f9f9f9;
			}
		</style>
	</head>
	<body>
		<h1>Test CORS Backend</h1>
		<p>
			Cette page permet de tester la configuration CORS du
			backend en émettant différents types de requêtes.
		</p>

		<div>
			<h2>Configuration</h2>
			<label for="frontendUrl">URL du Frontend:</label>
			<input
				type="text"
				id="frontendUrl"
				value="https://app-frontend-esgi-app.azurewebsites.net"
				style="width: 350px" />
		</div>

		<div>
			<h2>Tests CORS</h2>
			<button id="testCors">Test CORS</button>
			<button id="testOptions">Test OPTIONS</button>
			<button id="testAzureCors">Test Azure CORS</button>
			<button id="testPureCors">Test Pure CORS</button>
		</div>

		<div id="result" class="result">
			<p>Cliquez sur un bouton pour lancer un test.</p>
		</div>

		<script>
			// Éléments DOM
			const frontendUrlInput =
				document.getElementById("frontendUrl");
			const resultDiv = document.getElementById("result");

			// Fonction pour mettre à jour le résultat
			function updateResult(success, message, data) {
				let html = `<h3 class="${
					success ? "success" : "error"
				}">${message}</h3>`;

				if (data) {
					html += `<pre>${JSON.stringify(
						data,
						null,
						2
					)}</pre>`;
				}

				resultDiv.innerHTML = html;
			}

			// Test CORS
			document.getElementById("testCors").addEventListener(
				"click",
				async () => {
					try {
						updateResult(
							true,
							"Test CORS en cours...",
							null
						);

						const frontendUrl =
							frontendUrlInput.value;
						const response = await fetch(
							"test-cors.php",
							{
								method: "GET",
								headers: {
									"Content-Type":
										"application/json",
									Origin: frontendUrl
								}
							}
						);

						if (response.ok) {
							const data =
								await response.json();
							updateResult(
								true,
								"Test CORS réussi",
								data
							);
						} else {
							updateResult(
								false,
								`Échec du test CORS (${response.status}: ${response.statusText})`,
								null
							);
						}
					} catch (error) {
						updateResult(
							false,
							`Erreur: ${error.message}`,
							null
						);
					}
				}
			);

			// Test OPTIONS
			document.getElementById("testOptions").addEventListener(
				"click",
				async () => {
					try {
						updateResult(
							true,
							"Test OPTIONS en cours...",
							null
						);

						const frontendUrl =
							frontendUrlInput.value;
						const response = await fetch(
							"test-cors.php",
							{
								method: "OPTIONS",
								headers: {
									"Content-Type":
										"application/json",
									Origin: frontendUrl,
									"Access-Control-Request-Method":
										"GET",
									"Access-Control-Request-Headers":
										"Content-Type, X-Requested-With"
								}
							}
						);

						// Collecter les en-têtes CORS
						const corsHeaders = {};
						[
							"Access-Control-Allow-Origin",
							"Access-Control-Allow-Methods",
							"Access-Control-Allow-Headers",
							"Access-Control-Allow-Credentials",
							"Access-Control-Max-Age"
						].forEach((header) => {
							corsHeaders[header] =
								response.headers.get(
									header
								);
						});

						updateResult(
							response.ok,
							`Test OPTIONS ${
								response.ok
									? "réussi"
									: "échoué"
							} (${
								response.status
							}: ${
								response.statusText
							})`,
							corsHeaders
						);
					} catch (error) {
						updateResult(
							false,
							`Erreur: ${error.message}`,
							null
						);
					}
				}
			);

			// Test Azure CORS
			document.getElementById(
				"testAzureCors"
			).addEventListener("click", async () => {
				try {
					updateResult(
						true,
						"Test Azure CORS en cours...",
						null
					);

					const frontendUrl =
						frontendUrlInput.value;
					const response = await fetch(
						"azure-cors.php",
						{
							method: "GET",
							headers: {
								"Content-Type":
									"application/json",
								Origin: frontendUrl,
								"X-Requested-With":
									"XMLHttpRequest"
							}
						}
					);

					if (response.ok) {
						const data =
							await response.json();
						updateResult(
							true,
							"Test Azure CORS réussi",
							data
						);
					} else {
						updateResult(
							false,
							`Échec du test Azure CORS (${response.status}: ${response.statusText})`,
							null
						);
					}
				} catch (error) {
					updateResult(
						false,
						`Erreur: ${error.message}`,
						null
					);
				}
			});

			// Test Pure CORS
			document.getElementById(
				"testPureCors"
			).addEventListener("click", async () => {
				try {
					updateResult(
						true,
						"Test Pure CORS en cours...",
						null
					);

					const frontendUrl =
						frontendUrlInput.value;
					const response = await fetch(
						"pure-cors-test.php",
						{
							method: "GET",
							headers: {
								"Content-Type":
									"application/json",
								Origin: frontendUrl,
								"X-Requested-With":
									"XMLHttpRequest"
							}
						}
					);

					if (response.ok) {
						const data =
							await response.json();
						updateResult(
							true,
							"Test Pure CORS réussi",
							data
						);
					} else {
						updateResult(
							false,
							`Échec du test Pure CORS (${response.status}: ${response.statusText})`,
							null
						);
					}
				} catch (error) {
					updateResult(
						false,
						`Erreur: ${error.message}`,
						null
					);
				}
			});
		</script>
	</body>
</html>
