# Nginx Configuration for the API Backend

# CORS Headers
map $http_origin $cors_header {
"https://app-frontend-esgi-app.azurewebsites.net" "https://app-frontend-esgi-app.azurewebsites.net";
default "";
}

server {
listen 80;
server_name app-backend-esgi-app.azurewebsites.net;
root /home/site/wwwroot;
index index.php;

# CORS Headers
add_header 'Access-Control-Allow-Origin' $cors_header always;
add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
add_header 'Access-Control-Allow-Headers' 'Origin, X-Requested-With, Content-Type, Accept, Authorization' always;
add_header 'Access-Control-Allow-Credentials' 'true' always;

# Handle OPTIONS requests
if ($request_method = OPTIONS) {
add_header 'Access-Control-Allow-Origin' $cors_header always;
add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
add_header 'Access-Control-Allow-Headers' 'Origin, X-Requested-With, Content-Type, Accept, Authorization' always;
add_header 'Access-Control-Allow-Credentials' 'true' always;
add_header 'Content-Type' 'text/plain charset=UTF-8';
add_header 'Content-Length' 0;
return 204;
}

# API Rewrites
location ~ ^/api/status$ {
rewrite ^/api/status$ /status.php last;
}

location ~ ^/api/db-status$ {
rewrite ^/api/db-status$ /status.php?type=db last;
}

location ~ ^/api/(.+)$ {
rewrite ^/api/(.+)$ /routes/api.php?resource=$1 last;
}

# General PHP handling
location ~ \.php$ {
fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
fastcgi_index index.php;
fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
include fastcgi_params;
}

# Handle 404s
error_page 404 /404.html;
location = /404.html {
internal;
}
}