<!DOCTYPE html>
<html lang="fr">
	<head>
		<meta charset="UTF-8" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1.0" />
		<title>Test CORS</title>
		<style>
			body {
				font-family: Arial, sans-serif;
				max-width: 800px;
				margin: 0 auto;
				padding: 20px;
			}
			.result {
				margin-top: 20px;
				padding: 10px;
				background-color: #f5f5f5;
				border-radius: 5px;
			}
			pre {
				white-space: pre-wrap;
				background-color: #eee;
				padding: 10px;
				border-radius: 5px;
				overflow-x: auto;
			}
			button {
				padding: 10px 15px;
				background-color: #4caf50;
				color: white;
				border: none;
				border-radius: 5px;
				cursor: pointer;
				margin-right: 10px;
				margin-bottom: 10px;
			}
			button:hover {
				background-color: #45a049;
			}
			.error {
				color: red;
			}
			.success {
				color: green;
			}
		</style>
	</head>
	<body>
		<h1>Test CORS entre Frontend et Backend</h1>
		<p>
			Cette page permet de tester les requêtes CORS vers
			différentes endpoints du backend.
		</p>

		<h2>Configuration</h2>
		<div>
			<label for="baseUrl">URL du Backend:</label>
			<input
				type="text"
				id="baseUrl"
				value="https://app-backend-esgi-app.azurewebsites.net"
				style="width: 350px" />
		</div>

		<h2>Tests CORS</h2>
		<div>
			<button id="testOptions">Test OPTIONS</button>
			<button id="testGet">Test GET</button>
			<button id="testPost">Test POST</button>
			<button id="testCors">Test CORS Endpoint</button>
			<button id="testAzureCors">Test Azure CORS</button>
		</div>

		<div class="result" id="result">
			<p>Cliquez sur un bouton pour lancer un test.</p>
		</div>

		<script>
			// Récupérer les éléments DOM
			const baseUrlInput = document.getElementById("baseUrl");
			const resultDiv = document.getElementById("result");

			// Fonction pour mettre à jour le résultat
			function updateResult(success, message, data) {
				let html = `<h3 class="${
					success ? "success" : "error"
				}">${message}</h3>`;

				if (data) {
					html += `<pre>${
						typeof data === "string"
							? data
							: JSON.stringify(
									data,
									null,
									2
							  )
					}</pre>`;
				}

				resultDiv.innerHTML = html;
			}

			// Test de requête OPTIONS (preflight)
			document.getElementById("testOptions").addEventListener(
				"click",
				async () => {
					try {
						updateResult(
							true,
							"Test OPTIONS en cours...",
							null
						);

						const response = await fetch(
							`${baseUrlInput.value}/azure-cors.php`,
							{
								method: "OPTIONS",
								headers: {
									"Content-Type":
										"application/json",
									"X-Requested-With":
										"XMLHttpRequest"
								}
							}
						);

						// Récupérer les en-têtes de réponse
						const headers = {};
						response.headers.forEach(
							(value, name) => {
								headers[name] =
									value;
							}
						);

						updateResult(
							response.ok,
							`Test OPTIONS ${
								response.ok
									? "réussi"
									: "échoué"
							} (${response.status} ${
								response.statusText
							})`,
							{ headers }
						);
					} catch (error) {
						updateResult(
							false,
							"Erreur lors du test OPTIONS",
							error.message
						);
					}
				}
			);

			// Test de requête GET
			document.getElementById("testGet").addEventListener(
				"click",
				async () => {
					try {
						updateResult(
							true,
							"Test GET en cours...",
							null
						);

						const response = await fetch(
							`${baseUrlInput.value}/status.php`,
							{
								method: "GET",
								credentials:
									"include",
								headers: {
									"Content-Type":
										"application/json",
									"X-Requested-With":
										"XMLHttpRequest"
								}
							}
						);

						if (response.ok) {
							const data =
								await response.json();
							updateResult(
								true,
								"Test GET réussi",
								data
							);
						} else {
							updateResult(
								false,
								`Test GET échoué (${response.status} ${response.statusText})`,
								await response.text()
							);
						}
					} catch (error) {
						updateResult(
							false,
							"Erreur lors du test GET",
							error.message
						);
					}
				}
			);

			// Test de requête POST
			document.getElementById("testPost").addEventListener(
				"click",
				async () => {
					try {
						updateResult(
							true,
							"Test POST en cours...",
							null
						);

						const response = await fetch(
							`${baseUrlInput.value}/azure-cors.php`,
							{
								method: "POST",
								credentials:
									"include",
								headers: {
									"Content-Type":
										"application/json",
									"X-Requested-With":
										"XMLHttpRequest"
								},
								body: JSON.stringify(
									{
										test: true,
										timestamp: Date.now()
									}
								)
							}
						);

						if (response.ok) {
							const data =
								await response.json();
							updateResult(
								true,
								"Test POST réussi",
								data
							);
						} else {
							updateResult(
								false,
								`Test POST échoué (${response.status} ${response.statusText})`,
								await response.text()
							);
						}
					} catch (error) {
						updateResult(
							false,
							"Erreur lors du test POST",
							error.message
						);
					}
				}
			);

			// Test de l'endpoint CORS spécifique
			document.getElementById("testCors").addEventListener(
				"click",
				async () => {
					try {
						updateResult(
							true,
							"Test endpoint CORS en cours...",
							null
						);

						const response = await fetch(
							`${baseUrlInput.value}/test-cors.php`,
							{
								method: "GET",
								credentials:
									"include",
								headers: {
									"Content-Type":
										"application/json",
									"X-Requested-With":
										"XMLHttpRequest"
								}
							}
						);

						if (response.ok) {
							const data =
								await response.json();
							updateResult(
								true,
								"Test endpoint CORS réussi",
								data
							);
						} else {
							updateResult(
								false,
								`Test endpoint CORS échoué (${response.status} ${response.statusText})`,
								await response.text()
							);
						}
					} catch (error) {
						updateResult(
							false,
							"Erreur lors du test endpoint CORS",
							error.message
						);
					}
				}
			);

			// Test de l'endpoint Azure CORS spécifique
			document.getElementById(
				"testAzureCors"
			).addEventListener("click", async () => {
				try {
					updateResult(
						true,
						"Test Azure CORS en cours...",
						null
					);

					const response = await fetch(
						`${baseUrlInput.value}/azure-cors.php`,
						{
							method: "GET",
							credentials: "include",
							headers: {
								"Content-Type":
									"application/json",
								"X-Requested-With":
									"XMLHttpRequest"
							}
						}
					);

					if (response.ok) {
						const data =
							await response.json();
						updateResult(
							true,
							"Test Azure CORS réussi",
							data
						);
					} else {
						updateResult(
							false,
							`Test Azure CORS échoué (${response.status} ${response.statusText})`,
							await response.text()
						);
					}
				} catch (error) {
					updateResult(
						false,
						"Erreur lors du test Azure CORS",
						error.message
					);
				}
			});
		</script>
	</body>
</html>
