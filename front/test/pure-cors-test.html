<!DOCTYPE html>
<html lang="fr">
	<head>
		<meta charset="UTF-8" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1.0" />
		<title>Test CORS Avancé</title>
		<style>
			body {
				font-family: Arial, sans-serif;
				margin: 0;
				padding: 20px;
				background-color: #f5f5f5;
			}
			.container {
				max-width: 1200px;
				margin: 0 auto;
				background-color: white;
				padding: 20px;
				border-radius: 5px;
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
			}
			h1,
			h2,
			h3 {
				color: #333;
			}
			.btn {
				display: inline-block;
				padding: 8px 16px;
				margin: 5px 0;
				background-color: #4caf50;
				color: white;
				border: none;
				border-radius: 4px;
				cursor: pointer;
				font-size: 16px;
			}
			.btn:hover {
				background-color: #45a049;
			}
			.btn-danger {
				background-color: #f44336;
			}
			.btn-danger:hover {
				background-color: #d32f2f;
			}
			.btn-info {
				background-color: #2196f3;
			}
			.btn-info:hover {
				background-color: #0b7dda;
			}
			.result {
				margin-top: 20px;
				padding: 15px;
				background-color: #f9f9f9;
				border-left: 4px solid #4caf50;
				overflow-x: auto;
			}
			.error {
				border-left-color: #f44336;
			}
			pre {
				white-space: pre-wrap;
				margin: 0;
			}
			.form-group {
				margin-bottom: 15px;
			}
			label {
				display: block;
				margin-bottom: 5px;
				font-weight: bold;
			}
			select,
			input {
				width: 100%;
				padding: 8px;
				border: 1px solid #ddd;
				border-radius: 4px;
				box-sizing: border-box;
			}
			.test-group {
				margin-bottom: 30px;
				padding-bottom: 20px;
				border-bottom: 1px solid #eee;
			}
			.status-badge {
				display: inline-block;
				padding: 3px 8px;
				border-radius: 3px;
				font-size: 12px;
				font-weight: bold;
				color: white;
				background-color: #999;
			}
			.status-success {
				background-color: #4caf50;
			}
			.status-error {
				background-color: #f44336;
			}
			.status-pending {
				background-color: #ffc107;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<h1>Test CORS Avancé</h1>
			<p>
				Cette page permet de tester les problèmes de
				CORS de façon détaillée.
			</p>

			<div class="test-group">
				<h2>Configuration</h2>
				<div class="form-group">
					<label for="backendUrl"
						>URL Backend:</label
					>
					<input
						type="text"
						id="backendUrl"
						value="https://app-backend-esgi-app.azurewebsites.net" />
				</div>
				<div class="form-group">
					<label for="endpoint">Endpoint:</label>
					<input
						type="text"
						id="endpoint"
						value="azure-cors.php" />
				</div>
				<div class="form-group">
					<label for="method">Méthode:</label>
					<select id="method">
						<option value="GET">GET</option>
						<option value="POST">
							POST
						</option>
						<option value="PUT">PUT</option>
						<option value="DELETE">
							DELETE
						</option>
						<option value="OPTIONS">
							OPTIONS
						</option>
					</select>
				</div>
				<div class="form-group">
					<label for="credentials"
						>Credentials:</label
					>
					<select id="credentials">
						<option value="include">
							include
						</option>
						<option value="same-origin">
							same-origin
						</option>
						<option value="omit">
							omit
						</option>
					</select>
				</div>
				<div class="form-group">
					<label for="headers"
						>Headers (JSON):</label
					>
					<input
						type="text"
						id="headers"
						value='{"Content-Type": "application/json", "X-Requested-With": "XMLHttpRequest"}' />
				</div>
				<button id="testCorsBtn" class="btn">
					Tester CORS
				</button>
			</div>

			<div class="test-group">
				<h2>Tests Automatiques</h2>
				<p>
					Exécute une série de tests prédéfinis
					pour vérifier les configurations CORS:
				</p>
				<button
					id="runAllTestsBtn"
					class="btn btn-info">
					Exécuter Tous les Tests
				</button>
				<div id="autoTestResults"></div>
			</div>

			<div id="result" class="result" style="display: none">
				<h3>
					Résultat
					<span
						id="statusBadge"
						class="status-badge"
						>En attente</span
					>
				</h3>
				<pre id="responseData"></pre>
			</div>
		</div>

		<script>
			document.addEventListener(
				"DOMContentLoaded",
				function () {
					// Éléments DOM
					const backendUrlInput =
						document.getElementById(
							"backendUrl"
						);
					const endpointInput =
						document.getElementById(
							"endpoint"
						);
					const methodSelect =
						document.getElementById(
							"method"
						);
					const credentialsSelect =
						document.getElementById(
							"credentials"
						);
					const headersInput =
						document.getElementById(
							"headers"
						);
					const testCorsBtn =
						document.getElementById(
							"testCorsBtn"
						);
					const runAllTestsBtn =
						document.getElementById(
							"runAllTestsBtn"
						);
					const resultDiv =
						document.getElementById(
							"result"
						);
					const statusBadge =
						document.getElementById(
							"statusBadge"
						);
					const responseDataPre =
						document.getElementById(
							"responseData"
						);
					const autoTestResultsDiv =
						document.getElementById(
							"autoTestResults"
						);

					// Test CORS manuel
					testCorsBtn.addEventListener(
						"click",
						async function () {
							resultDiv.style.display =
								"block";
							statusBadge.textContent =
								"En cours...";
							statusBadge.className =
								"status-badge status-pending";
							responseDataPre.textContent =
								"Requête en cours...";

							try {
								const url =
									getFullUrl();
								const headers =
									JSON.parse(
										headersInput.value
									);
								const method =
									methodSelect.value;
								const credentials =
									credentialsSelect.value;

								const result =
									await testCors(
										url,
										method,
										headers,
										credentials
									);
								displayResult(
									result
								);
							} catch (error) {
								displayError(
									error
								);
							}
						}
					);

					// Tests automatiques
					runAllTestsBtn.addEventListener(
						"click",
						async function () {
							autoTestResultsDiv.innerHTML =
								"<p>Exécution des tests...</p>";

							const baseUrl =
								backendUrlInput.value;
							const endpoint =
								endpointInput.value;
							const testUrl = `${baseUrl}/${endpoint}`;

							const tests = [
								{
									name: "GET standard avec credentials",
									config: {
										url: testUrl,
										method: "GET",
										headers: {
											"Content-Type":
												"application/json",
											"X-Requested-With":
												"XMLHttpRequest"
										},
										credentials:
											"include"
									}
								},
								{
									name: "GET sans credentials",
									config: {
										url: testUrl,
										method: "GET",
										headers: {
											"Content-Type":
												"application/json",
											"X-Requested-With":
												"XMLHttpRequest"
										},
										credentials:
											"omit"
									}
								},
								{
									name: "OPTIONS preflight",
									config: {
										url: testUrl,
										method: "OPTIONS",
										headers: {
											"Content-Type":
												"application/json",
											"X-Requested-With":
												"XMLHttpRequest"
										},
										credentials:
											"include"
									}
								},
								{
									name: "POST avec credentials",
									config: {
										url: testUrl,
										method: "POST",
										headers: {
											"Content-Type":
												"application/json",
											"X-Requested-With":
												"XMLHttpRequest"
										},
										credentials:
											"include"
									}
								},
								{
									name: "GET avec headers miminal",
									config: {
										url: testUrl,
										method: "GET",
										headers: {},
										credentials:
											"include"
									}
								}
							];

							autoTestResultsDiv.innerHTML =
								"";

							for (const test of tests) {
								const testDiv =
									document.createElement(
										"div"
									);
								testDiv.className =
									"test-result";
								testDiv.innerHTML = `
                    <h3>${test.name} <span class="status-badge status-pending">En cours...</span></h3>
                    <pre style="display: none;"></pre>
                `;
								autoTestResultsDiv.appendChild(
									testDiv
								);

								const statusBadge =
									testDiv.querySelector(
										".status-badge"
									);
								const resultPre =
									testDiv.querySelector(
										"pre"
									);

								try {
									const result =
										await testCors(
											test
												.config
												.url,
											test
												.config
												.method,
											test
												.config
												.headers,
											test
												.config
												.credentials
										);

									statusBadge.textContent =
										result.success
											? "Succès"
											: "Échec";
									statusBadge.className = `status-badge ${
										result.success
											? "status-success"
											: "status-error"
									}`;

									resultPre.textContent =
										JSON.stringify(
											result,
											null,
											2
										);
									resultPre.style.display =
										"block";
								} catch (error) {
									statusBadge.textContent =
										"Erreur";
									statusBadge.className =
										"status-badge status-error";

									resultPre.textContent = `Erreur: ${error.message}`;
									resultPre.style.display =
										"block";
								}
							}
						}
					);

					// Fonctions utilitaires
					function getFullUrl() {
						let url = backendUrlInput.value;
						if (
							!url.endsWith("/") &&
							!endpointInput.value.startsWith(
								"/"
							)
						) {
							url += "/";
						}
						url += endpointInput.value;
						return url;
					}

					async function testCors(
						url,
						method,
						headers,
						credentials
					) {
						try {
							console.log(
								`Fetching ${url} with method ${method}, credentials ${credentials}`
							);
							console.log(
								"Headers:",
								headers
							);

							const startTime =
								performance.now();
							const response =
								await fetch(
									url,
									{
										method: method,
										headers: headers,
										credentials:
											credentials
									}
								);
							const endTime =
								performance.now();

							const responseHeaders =
								{};
							response.headers.forEach(
								(
									value,
									name
								) => {
									responseHeaders[
										name
									] =
										value;
								}
							);

							let responseData;
							let jsonError = null;

							try {
								responseData =
									await response.json();
							} catch (error) {
								jsonError =
									error.message;
								responseData =
									await response.text();
							}

							return {
								success: response.ok,
								status: response.status,
								statusText: response.statusText,
								headers: responseHeaders,
								responseTime:
									Math.round(
										endTime -
											startTime
									),
								data: responseData,
								jsonError: jsonError,
								url: url,
								method: method,
								requestHeaders:
									headers,
								credentials:
									credentials
							};
						} catch (error) {
							console.error(
								"Fetch error:",
								error
							);
							throw error;
						}
					}

					function displayResult(result) {
						statusBadge.textContent =
							result.success
								? `Succès (${result.status})`
								: `Échec (${result.status})`;
						statusBadge.className = `status-badge ${
							result.success
								? "status-success"
								: "status-error"
						}`;

						result.timestamp =
							new Date().toISOString();
						responseDataPre.textContent =
							JSON.stringify(
								result,
								null,
								2
							);

						resultDiv.className =
							result.success
								? "result"
								: "result error";
					}

					function displayError(error) {
						statusBadge.textContent =
							"Erreur";
						statusBadge.className =
							"status-badge status-error";
						responseDataPre.textContent = `Erreur: ${error.message}`;
						resultDiv.className =
							"result error";
					}
				}
			);
		</script>
	</body>
</html>
