<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1.0" />
		<title>Server Diagnostics Tool</title>
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
			rel="stylesheet" />
		<style>
			.pre-scrollable {
				max-height: 300px;
				overflow-y: auto;
			}
			.code-block {
				background-color: #f8f9fa;
				padding: 1rem;
				border-radius: 0.25rem;
				font-family: monospace;
				white-space: pre-wrap;
				font-size: 0.9rem;
			}
			.status-success {
				color: #198754;
			}
			.status-error {
				color: #dc3545;
			}
			.status-warning {
				color: #fd7e14;
			}
			.test-card {
				margin-bottom: 1rem;
			}
			.endpoint-badge {
				min-width: 90px;
			}
			.log-container {
				height: 300px;
				overflow-y: auto;
				background-color: #212529;
				color: #f8f9fa;
				padding: 1rem;
				border-radius: 0.25rem;
				font-family: monospace;
				font-size: 0.9rem;
			}
			.log-info {
				color: #0dcaf0;
			}
			.log-error {
				color: #dc3545;
			}
			.log-warning {
				color: #ffc107;
			}
			.log-success {
				color: #198754;
			}
			#console-log {
				margin-top: 2rem;
			}
		</style>
	</head>
	<body>
		<div class="container my-4">
			<h1 class="text-center mb-4">
				Azure Server Diagnostics Tool
			</h1>

			<!-- Test Controls -->
			<div class="row mb-4">
				<div class="col-md-6 offset-md-3">
					<div class="card">
						<div
							class="card-header bg-primary text-white">
							<h5 class="mb-0">
								Run Diagnostics
							</h5>
						</div>
						<div class="card-body">
							<form
								id="diagnostics-form">
								<div
									class="mb-3">
									<label
										for="backend-url"
										class="form-label"
										>Backend
										URL:</label
									>
									<input
										type="text"
										class="form-control"
										id="backend-url"
										value="https://app-backend-esgi-app.azurewebsites.net/server-diagnostics.php" />
								</div>
								<div
									class="mb-3 form-check">
									<input
										type="checkbox"
										class="form-check-input"
										id="use-proxy" />
									<label
										class="form-check-label"
										for="use-proxy"
										>Use
										local
										proxy
										(to
										avoid
										CORS
										issues)</label
									>
									<div
										class="form-text">
										If
										checked,
										the
										request
										will
										be
										made
										through
										backend-proxy.php
										to
										avoid
										CORS
										restrictions
									</div>
								</div>
								<div
									class="d-grid">
									<button
										type="submit"
										class="btn btn-primary">
										Run
										Diagnostics
									</button>
								</div>
							</form>
						</div>
					</div>
				</div>
			</div>

			<!-- Loading indicator -->
			<div id="loading" class="d-none text-center my-5">
				<div
					class="spinner-border text-primary"
					role="status">
					<span class="visually-hidden"
						>Loading...</span
					>
				</div>
				<p class="mt-3">
					Running diagnostics, please wait...
				</p>
			</div>

			<!-- Results section -->
			<div id="results-container" class="d-none">
				<ul
					class="nav nav-tabs"
					id="resultTabs"
					role="tablist">
					<li
						class="nav-item"
						role="presentation">
						<button
							class="nav-link active"
							id="summary-tab"
							data-bs-toggle="tab"
							data-bs-target="#summary"
							type="button"
							role="tab">
							Summary
						</button>
					</li>
					<li
						class="nav-item"
						role="presentation">
						<button
							class="nav-link"
							id="server-tab"
							data-bs-toggle="tab"
							data-bs-target="#server"
							type="button"
							role="tab">
							Server Info
						</button>
					</li>
					<li
						class="nav-item"
						role="presentation">
						<button
							class="nav-link"
							id="endpoints-tab"
							data-bs-toggle="tab"
							data-bs-target="#endpoints"
							type="button"
							role="tab">
							Endpoints
						</button>
					</li>
					<li
						class="nav-item"
						role="presentation">
						<button
							class="nav-link"
							id="files-tab"
							data-bs-toggle="tab"
							data-bs-target="#files"
							type="button"
							role="tab">
							Files
						</button>
					</li>
					<li
						class="nav-item"
						role="presentation">
						<button
							class="nav-link"
							id="logs-tab"
							data-bs-toggle="tab"
							data-bs-target="#logs"
							type="button"
							role="tab">
							Logs
						</button>
					</li>
					<li
						class="nav-item"
						role="presentation">
						<button
							class="nav-link"
							id="raw-tab"
							data-bs-toggle="tab"
							data-bs-target="#raw"
							type="button"
							role="tab">
							Raw Data
						</button>
					</li>
				</ul>

				<div
					class="tab-content mt-3"
					id="resultTabsContent">
					<!-- Summary Tab -->
					<div
						class="tab-pane fade show active"
						id="summary"
						role="tabpanel">
						<div class="row">
							<div class="col-md-6">
								<div
									class="card test-card">
									<div
										class="card-header">
										<h5
											class="mb-0">
											Server
											Overview
										</h5>
									</div>
									<div
										class="card-body">
										<div
											id="server-summary"></div>
									</div>
								</div>
							</div>
							<div class="col-md-6">
								<div
									class="card test-card">
									<div
										class="card-header">
										<h5
											class="mb-0">
											Configuration
											Status
										</h5>
									</div>
									<div
										class="card-body">
										<div
											id="config-summary"></div>
									</div>
								</div>
							</div>
						</div>

						<div class="row">
							<div class="col-md-6">
								<div
									class="card test-card">
									<div
										class="card-header">
										<h5
											class="mb-0">
											API
											Endpoints
											Status
										</h5>
									</div>
									<div
										class="card-body">
										<div
											id="api-summary"></div>
									</div>
								</div>
							</div>
							<div class="col-md-6">
								<div
									class="card test-card">
									<div
										class="card-header">
										<h5
											class="mb-0">
											URL
											Rewriting
											Status
										</h5>
									</div>
									<div
										class="card-body">
										<div
											id="rewrite-summary"></div>
									</div>
								</div>
							</div>
						</div>

						<div
							class="card test-card mt-3">
							<div
								class="card-header">
								<h5
									class="mb-0">
									Recommendations
								</h5>
							</div>
							<div class="card-body">
								<div
									id="recommendations"></div>
							</div>
						</div>
					</div>

					<!-- Server Info Tab -->
					<div
						class="tab-pane fade"
						id="server"
						role="tabpanel">
						<div class="card">
							<div
								class="card-header">
								<h5
									class="mb-0">
									Server
									Information
								</h5>
							</div>
							<div class="card-body">
								<div
									id="server-info"></div>
							</div>
						</div>

						<div class="card mt-3">
							<div
								class="card-header">
								<h5
									class="mb-0">
									Environment
									Information
								</h5>
							</div>
							<div class="card-body">
								<div
									id="environment-info"></div>
							</div>
						</div>

						<div class="card mt-3">
							<div
								class="card-header">
								<h5
									class="mb-0">
									Directory
									Structure
								</h5>
							</div>
							<div class="card-body">
								<div
									id="directory-structure"></div>
							</div>
						</div>
					</div>

					<!-- Endpoints Tab -->
					<div
						class="tab-pane fade"
						id="endpoints"
						role="tabpanel">
						<div class="card">
							<div
								class="card-header">
								<h5
									class="mb-0">
									API
									Endpoints
								</h5>
							</div>
							<div class="card-body">
								<div
									id="endpoints-list"></div>
							</div>
						</div>
					</div>

					<!-- Files Tab -->
					<div
						class="tab-pane fade"
						id="files"
						role="tabpanel">
						<div class="card">
							<div
								class="card-header">
								<h5
									class="mb-0">
									Configuration
									Files
								</h5>
							</div>
							<div class="card-body">
								<div
									id="files-list"></div>
							</div>
						</div>
					</div>

					<!-- Logs Tab -->
					<div
						class="tab-pane fade"
						id="logs"
						role="tabpanel">
						<div class="card">
							<div
								class="card-header">
								<h5
									class="mb-0">
									Server
									Logs
								</h5>
							</div>
							<div class="card-body">
								<div
									id="server-logs"></div>
							</div>
						</div>

						<div class="card mt-3">
							<div
								class="card-header">
								<h5
									class="mb-0">
									Diagnostic
									Logs
								</h5>
							</div>
							<div class="card-body">
								<div
									id="diagnostic-logs"
									class="log-container"></div>
							</div>
						</div>
					</div>

					<!-- Raw Data Tab -->
					<div
						class="tab-pane fade"
						id="raw"
						role="tabpanel">
						<div class="card">
							<div
								class="card-header">
								<h5
									class="mb-0">
									Raw
									Diagnostic
									Data
								</h5>
							</div>
							<div class="card-body">
								<pre
									id="raw-data"
									class="pre-scrollable code-block"></pre>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- Console log for debugging -->
			<div id="console-log" class="mt-4 d-none">
				<div class="card">
					<div
						class="card-header bg-dark text-white">
						<h5 class="mb-0">
							Console Log
						</h5>
					</div>
					<div class="card-body p-0">
						<div
							id="console-output"
							class="log-container"></div>
					</div>
				</div>
			</div>
		</div>

		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
		<script>
			document.addEventListener(
				"DOMContentLoaded",
				function () {
					const consoleLog =
						document.getElementById(
							"console-log"
						);
					const consoleOutput =
						document.getElementById(
							"console-output"
						);

					// Show console for debugging
					consoleLog.classList.remove("d-none");

					// Custom console.log function that also outputs to our UI
					const originalConsoleLog = console.log;
					console.log = function () {
						// Call the original console.log
						originalConsoleLog.apply(
							console,
							arguments
						);

						// Add to our UI console
						const message = Array.from(
							arguments
						)
							.map((arg) => {
								if (
									typeof arg ===
									"object"
								) {
									return JSON.stringify(
										arg,
										null,
										2
									);
								}
								return arg;
							})
							.join(" ");

						const logElement =
							document.createElement(
								"div"
							);
						logElement.className =
							"log-info";
						logElement.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
						consoleOutput.appendChild(
							logElement
						);

						// Auto-scroll to bottom
						consoleOutput.scrollTop =
							consoleOutput.scrollHeight;
					};

					// Extend for other console methods
					const originalConsoleError =
						console.error;
					console.error = function () {
						originalConsoleError.apply(
							console,
							arguments
						);
						const message =
							Array.from(
								arguments
							).join(" ");
						const logElement =
							document.createElement(
								"div"
							);
						logElement.className =
							"log-error";
						logElement.textContent = `[${new Date().toLocaleTimeString()}] ERROR: ${message}`;
						consoleOutput.appendChild(
							logElement
						);
						consoleOutput.scrollTop =
							consoleOutput.scrollHeight;
					};

					// Handle form submission
					const diagnosticsForm =
						document.getElementById(
							"diagnostics-form"
						);
					diagnosticsForm.addEventListener(
						"submit",
						async function (e) {
							e.preventDefault();

							const backendUrl =
								document.getElementById(
									"backend-url"
								).value;
							const useProxy =
								document.getElementById(
									"use-proxy"
								).checked;
							const loadingIndicator =
								document.getElementById(
									"loading"
								);
							const resultsContainer =
								document.getElementById(
									"results-container"
								);

							// Show loading, hide results
							loadingIndicator.classList.remove(
								"d-none"
							);
							resultsContainer.classList.add(
								"d-none"
							);

							console.log(
								`Starting diagnostics test for: ${backendUrl}`
							);

							try {
								let fetchUrl,
									fetchOptions;

								if (useProxy) {
									// Use the backend-proxy.php with the target URL as a parameter
									fetchUrl =
										"./backend-proxy.php";
									fetchOptions =
										{
											method: "POST",
											headers: {
												"Content-Type":
													"application/x-www-form-urlencoded"
											},
											body: `url=${encodeURIComponent(
												backendUrl
											)}`
										};
									console.log(
										"Using proxy to avoid CORS issues"
									);
								} else {
									// Direct fetch with CORS
									fetchUrl =
										backendUrl;
									fetchOptions =
										{
											method: "GET",
											credentials:
												"include",
											headers: {
												Accept: "application/json"
											},
											mode: "cors"
										};
								}

								const response =
									await fetch(
										fetchUrl,
										fetchOptions
									);

								if (
									!response.ok
								) {
									throw new Error(
										`Server responded with status: ${response.status}`
									);
								}

								const data =
									await response.json();
								console.log(
									"Diagnostics data received",
									data
								);

								// Process and display the results
								displayResults(
									data
								);

								// Hide loading, show results
								loadingIndicator.classList.add(
									"d-none"
								);
								resultsContainer.classList.remove(
									"d-none"
								);
							} catch (error) {
								console.error(
									"Error running diagnostics:",
									error
								);

								// Hide loading
								loadingIndicator.classList.add(
									"d-none"
								);

								// Create a detailed error message
								let errorMessage = `Error: ${error.message}`;
								let suggestProxy =
									!useProxy; // Only suggest proxy if not already using it

								// Check for specific CORS errors
								if (
									error.message.includes(
										"Failed to fetch"
									)
								) {
									errorMessage =
										"CORS Error: The browser blocked the request due to Cross-Origin Resource Sharing (CORS) policy.\n\n" +
										"This likely means the backend server is not properly configured to allow requests from this origin. " +
										"Possible solutions:\n" +
										"1. Ensure the backend has 'Access-Control-Allow-Origin' header set to include this domain\n" +
										"2. Check the 'Use local proxy' option to bypass CORS\n" +
										"3. Try accessing directly from the backend domain";

									if (
										suggestProxy
									) {
										// Suggest using the proxy option and offer to try again with it
										if (
											confirm(
												"CORS error detected. Would you like to try again using the proxy option to avoid this error?"
											)
										) {
											document.getElementById(
												"use-proxy"
											).checked = true;
											// Resubmit the form
											diagnosticsForm.dispatchEvent(
												new Event(
													"submit"
												)
											);
											return; // Skip showing the error dialog
										}
									}
								}

								// Show error message with more details
								alert(
									errorMessage
								);
							}
						}
					);

					// Function to display diagnostic results
					function displayResults(data) {
						// Raw data
						document.getElementById(
							"raw-data"
						).textContent = JSON.stringify(
							data,
							null,
							2
						);

						// Handle potential proxy response structure
						// Check if data is wrapped in a proxy debug structure
						if (
							data.proxy_debug &&
							!data.server_info
						) {
							console.log(
								"Proxy debug data detected, unwrapping response"
							);
							alert(
								"The data was received through a proxy and may be incomplete. Please check the raw data tab for complete information."
							);
						}

						// Server summary
						const serverSummary =
							document.getElementById(
								"server-summary"
							);
						try {
							if (data.server_info) {
								serverSummary.innerHTML = `
                    <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Server Type
                            <span class="badge bg-info">${
					data.server_info.webserver_type ||
					"Unknown"
				}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            PHP Version
                            <span class="badge bg-info">${
					data.server_info.php_version ||
					"Unknown"
				}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Server Software
                            <span class="badge bg-info">${
					data.server_info.server_software ||
					"Unknown"
				}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Time
                            <span class="badge bg-info">${
					data.timestamp || "Unknown"
				}</span>
                        </li>
                    </ul>
                `;
							} else {
								serverSummary.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Server information not available</strong><br>
                        The diagnostics response doesn't include server information.
                    </div>
                `;
							}
						} catch (error) {
							console.error(
								"Error rendering server summary:",
								error
							);
							serverSummary.innerHTML = `
                <div class="alert alert-danger">
                    <strong>Error rendering server information</strong><br>
                    ${error.message}
                </div>
            `;
						}

						// Config summary
						const configSummary =
							document.getElementById(
								"config-summary"
							);
						try {
							if (data.config_files) {
								const configItems =
									[];
								for (const [
									file,
									info
								] of Object.entries(
									data.config_files
								)) {
									const status =
										info.exists
											? info.readable
												? "success"
												: "warning"
											: "danger";
									const statusText =
										info.exists
											? info.readable
												? "OK"
												: "Not Readable"
											: "Missing";

									configItems.push(`
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            ${file}
                            <span class="badge bg-${status}">${statusText}</span>
                        </li>
                    `);
								}
								configSummary.innerHTML = `<ul class="list-group">${configItems.join(
									""
								)}</ul>`;
							} else {
								configSummary.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Configuration information not available</strong><br>
                        The diagnostics response doesn't include configuration files information.
                    </div>
                `;
							}
						} catch (error) {
							console.error(
								"Error rendering config summary:",
								error
							);
							configSummary.innerHTML = `
                <div class="alert alert-danger">
                    <strong>Error rendering configuration information</strong><br>
                    ${error.message}
                </div>
            `;
						}

						// API endpoints summary
						const apiSummary =
							document.getElementById(
								"api-summary"
							);
						try {
							if (data.endpoints) {
								const apiItems =
									[];
								for (const [
									name,
									info
								] of Object.entries(
									data.endpoints
								)) {
									const status =
										info.status_code >=
											200 &&
										info.status_code <
											300
											? "success"
											: info.status_code ===
											  401
											? "warning"
											: "danger";

									apiItems.push(`
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            ${name}
                            <span class="badge bg-${status} endpoint-badge">${info.status_code}</span>
                        </li>
                    `);
								}
								apiSummary.innerHTML = `<ul class="list-group">${apiItems.join(
									""
								)}</ul>`;
							} else {
								apiSummary.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>API endpoint information not available</strong><br>
                        The diagnostics response doesn't include API endpoint data.
                    </div>
                `;
							}
						} catch (error) {
							console.error(
								"Error rendering API summary:",
								error
							);
							apiSummary.innerHTML = `
                <div class="alert alert-danger">
                    <strong>Error rendering API endpoint information</strong><br>
                    ${error.message}
                </div>
            `;
						}

						// URL Rewriting summary
						const rewriteSummary =
							document.getElementById(
								"rewrite-summary"
							);
						try {
							if (data.endpoints) {
								const apiRoot =
									data
										.endpoints[
										"api-root"
									];
								const apiStatus =
									data
										.endpoints[
										"api-status"
									];

								const rewriteWorking =
									apiRoot &&
									apiRoot.status_code !==
										404 &&
									apiStatus &&
									apiStatus.status_code !==
										404;

								rewriteSummary.innerHTML = `
                    <div class="alert alert-${
				rewriteWorking ? "success" : "danger"
			}">
                        <h5 class="alert-heading">URL Rewriting</h5>
                        <p>URL rewriting is ${
				rewriteWorking
					? "working correctly"
					: "not working correctly"
			}</p>
                        <hr>
                        <p class="mb-0">${
				rewriteWorking
					? "The API routing system is functioning properly."
					: "API routes like /api/status are returning 404 errors, indicating the URL rewrite rules are not being applied."
			}</p>
                    </div>
                `;
							} else {
								rewriteSummary.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>URL rewriting information not available</strong><br>
                        The diagnostics response doesn't include URL rewriting test data.
                    </div>
                `;
							}
						} catch (error) {
							console.error(
								"Error rendering rewrite summary:",
								error
							);
							rewriteSummary.innerHTML = `
                <div class="alert alert-danger">
                    <strong>Error rendering URL rewriting information</strong><br>
                    ${error.message}
                </div>
            `;
						}

						// Generate recommendations
						const recommendations =
							document.getElementById(
								"recommendations"
							);
						try {
							const recommendationsList =
								[];

							// Only add recommendations if we have the necessary data
							if (
								data.config_files &&
								data.endpoints
							) {
								// Check if index.php exists and is readable
								if (
									!data
										.config_files
										.index ||
									!data
										.config_files[
										"index.php"
									] ||
									!data
										.config_files[
										"index.php"
									].exists
								) {
									recommendationsList.push(`
                        <div class="alert alert-danger">
                            <strong>Deploy updated index.php:</strong> The main router file (index.php) is missing on the server.
                            You need to upload the newly created index.php to handle API routing.
                        </div>
                    `);
								}

								// Check if API routes return 404
								if (
									data
										.endpoints[
										"api-root"
									] &&
									data
										.endpoints[
										"api-status"
									] &&
									data
										.endpoints[
										"api-root"
									]
										.status_code ===
										404 &&
									data
										.endpoints[
										"api-status"
									]
										.status_code ===
										404
								) {
									recommendationsList.push(`
                        <div class="alert alert-danger">
                            <strong>Configure URL Rewriting:</strong> API routes are returning 404 errors. You need to:
                            <ul>
                                <li>Make sure the server is configured to use index.php as the entry point for all requests</li>
                                <li>Upload the nginx configuration or configure .htaccess to properly handle URL rewrites</li>
                            </ul>
                        </div>
                    `);
								}

								// Check if direct router access works but requires auth
								if (
									data
										.endpoints[
										"api-router-classes"
									] &&
									data
										.endpoints[
										"api-router-classes"
									]
										.status_code ===
										401
								) {
									recommendationsList.push(`
                        <div class="alert alert-warning">
                            <strong>Authentication Required:</strong> Direct access to the API router requires authentication.
                            You need to login first before accessing protected API endpoints.
                        </div>
                    `);
								}

								// Add general recommendation about using the proxy
								recommendationsList.push(`
                    <div class="alert alert-info">
                        <strong>Use the Backend Proxy:</strong> Until the server routing is fully configured,
                        continue using backend-proxy.php from the frontend, which can fall back to direct script access.
                    </div>
                `);
							} else {
								recommendationsList.push(`
                <div class="alert alert-warning">
                    <strong>Limited data available:</strong> Unable to generate complete recommendations because the diagnostic data is incomplete.
                    Try running the diagnostics again with the proxy option checked.
                </div>
            `);
							}

							recommendations.innerHTML =
								recommendationsList.join(
									""
								);
						} catch (error) {
							console.error(
								"Error generating recommendations:",
								error
							);
							recommendations.innerHTML = `
                <div class="alert alert-danger">
                    <strong>Error generating recommendations</strong><br>
                    ${error.message}
                </div>
            `;
						}

						// Server info detail tab
						const serverInfo =
							document.getElementById(
								"server-info"
							);
						try {
							if (data.server_info) {
								const serverInfoItems =
									[];
								for (const [
									key,
									value
								] of Object.entries(
									data.server_info
								)) {
									if (
										key !==
											"directory_structure" &&
										key !==
											"php_modules" &&
										typeof value !==
											"object"
									) {
										serverInfoItems.push(`
                            <tr>
                                <th scope="row">${key}</th>
                                <td>${value}</td>
                            </tr>
                        `);
									}
								}
								serverInfo.innerHTML = `
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th scope="col">Property</th>
                                <th scope="col">Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${serverInfoItems.join("")}
                        </tbody>
                    </table>
                `;
							} else {
								serverInfo.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Server information not available</strong><br>
                        The diagnostics response doesn't include server information.
                    </div>
                `;
							}
						} catch (error) {
							console.error(
								"Error rendering server info:",
								error
							);
							serverInfo.innerHTML = `
                <div class="alert alert-danger">
                    <strong>Error rendering server information</strong><br>
                    ${error.message}
                </div>
            `;
						}

						// Environment info
						const environmentInfo =
							document.getElementById(
								"environment-info"
							);
						try {
							if (data.environment) {
								const envItems =
									[];
								for (const [
									key,
									value
								] of Object.entries(
									data.environment
								)) {
									if (
										key !==
											"environment_variables" &&
										typeof value !==
											"object"
									) {
										envItems.push(`
                            <tr>
                                <th scope="row">${key}</th>
                                <td>${value}</td>
                            </tr>
                        `);
									}
								}
								environmentInfo.innerHTML = `
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th scope="col">Property</th>
                                <th scope="col">Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${envItems.join("")}
                        </tbody>
                    </table>
                `;
							} else {
								environmentInfo.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Environment information not available</strong><br>
                        The diagnostics response doesn't include environment data.
                    </div>
                `;
							}
						} catch (error) {
							console.error(
								"Error rendering environment info:",
								error
							);
							environmentInfo.innerHTML = `
                <div class="alert alert-danger">
                    <strong>Error rendering environment information</strong><br>
                    ${error.message}
                </div>
            `;
						}

						// Directory structure
						const directoryStructure =
							document.getElementById(
								"directory-structure"
							);
						try {
							if (
								data.server_info &&
								data.server_info
									.directory_structure
							) {
								const dirItems =
									[];
								for (const [
									dir,
									files
								] of Object.entries(
									data
										.server_info
										.directory_structure
								)) {
									dirItems.push(`
                            <div class="card mb-3">
                                <div class="card-header">${dir}/</div>
                                <div class="card-body">
                                    ${
						Array.isArray(files)
							? `<pre class="mb-0">${files.join(
									"\n"
							  )}</pre>`
							: typeof files ===
							  "object"
							? `<pre class="mb-0">${Object.entries(
									files
							  )
									.map(
										([
											k,
											v
										]) =>
											`${k}: ${v}`
									)
									.join(
										"\n"
									)}</pre>`
							: `<p class="text-danger mb-0">${files}</p>`
					}
                                </div>
                            </div>
                        `);
								}
								directoryStructure.innerHTML =
									dirItems.join(
										""
									);
							} else {
								directoryStructure.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Directory structure information not available</strong><br>
                        The diagnostics response doesn't include directory structure data.
                    </div>
                `;
							}
						} catch (error) {
							console.error(
								"Error rendering directory structure:",
								error
							);
							directoryStructure.innerHTML = `
                <div class="alert alert-danger">
                    <strong>Error rendering directory structure</strong><br>
                    ${error.message}
                </div>
            `;
						}

						// Endpoints list
						const endpointsList =
							document.getElementById(
								"endpoints-list"
							);
						try {
							if (data.endpoints) {
								const endpointItems =
									[];
								for (const [
									name,
									info
								] of Object.entries(
									data.endpoints
								)) {
									const statusClass =
										info.status_code >=
											200 &&
										info.status_code <
											300
											? "success"
											: info.status_code ===
											  401
											? "warning"
											: "danger";

									let responseContent =
										"";
									if (
										info.is_json &&
										info.json_data
									) {
										responseContent = `<pre class="code-block">${JSON.stringify(
											info.json_data,
											null,
											2
										)}</pre>`;
									} else if (
										info.raw_body_preview
									) {
										responseContent = `<pre class="code-block">${info.raw_body_preview}</pre>`;
									}

									endpointItems.push(`
                        <div class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span>${name} (${info.method || "GET"})</span>
                                <span class="badge bg-${statusClass}">${
										info.status_code
									}</span>
                            </div>
                            <div class="card-body">
                                <p class="mb-1"><strong>URL:</strong> ${
					info.url || "N/A"
				}</p>
                                <p class="mb-1"><strong>Content Type:</strong> ${
					info.content_type || "None"
				}</p>
                                ${
					info.error
						? `<p class="text-danger mb-1"><strong>Error:</strong> ${info.error}</p>`
						: ""
				}
                                ${
					responseContent
						? `
                                    <div class="mt-3">
                                        <h6>Response:</h6>
                                        ${responseContent}
                                    </div>
                                `
						: ""
				}
                            </div>
                        </div>
                    `);
								}
								endpointsList.innerHTML =
									endpointItems.join(
										""
									);
							} else {
								endpointsList.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Endpoint information not available</strong><br>
                        The diagnostics response doesn't include endpoint test data.
                    </div>
                `;
							}
						} catch (error) {
							console.error(
								"Error rendering endpoints list:",
								error
							);
							endpointsList.innerHTML = `
                <div class="alert alert-danger">
                    <strong>Error rendering endpoint information</strong><br>
                    ${error.message}
                </div>
            `;
						}

						// Files list
						const filesList =
							document.getElementById(
								"files-list"
							);
						try {
							if (data.config_files) {
								const fileItems =
									[];
								for (const [
									file,
									info
								] of Object.entries(
									data.config_files
								)) {
									const statusClass =
										info.exists
											? info.readable
												? "success"
												: "warning"
											: "danger";
									const statusText =
										info.exists
											? info.readable
												? "OK"
												: "Not Readable"
											: "Missing";

									fileItems.push(`
                        <div class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span>${file}</span>
                                <span class="badge bg-${statusClass}">${statusText}</span>
                            </div>
                            <div class="card-body">
                                <p class="mb-1"><strong>Path:</strong> ${
					info.path || "N/A"
				}</p>
                                <p class="mb-1"><strong>Size:</strong> ${
					info.size || 0
				} bytes</p>
                            </div>
                        </div>
                    `);
								}
								filesList.innerHTML =
									fileItems.join(
										""
									);
							} else {
								filesList.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>File information not available</strong><br>
                        The diagnostics response doesn't include configuration file data.
                    </div>
                `;
							}
						} catch (error) {
							console.error(
								"Error rendering files list:",
								error
							);
							filesList.innerHTML = `
                <div class="alert alert-danger">
                    <strong>Error rendering file information</strong><br>
                    ${error.message}
                </div>
            `;
						}

						// Logs tab
						const serverLogs =
							document.getElementById(
								"server-logs"
							);
						try {
							const logsContent = [];

							if (
								data.logs &&
								Object.keys(
									data.logs
								).length > 0
							) {
								for (const [
									logName,
									logLines
								] of Object.entries(
									data.logs
								)) {
									if (
										Array.isArray(
											logLines
										) &&
										logLines.length >
											0
									) {
										logsContent.push(`
                                <div class="card mb-3">
                                    <div class="card-header">${logName}</div>
                                    <div class="card-body p-0">
                                        <div class="log-container">
                                            ${logLines
							.map(
								(line) =>
									`<div>${line}</div>`
							)
							.join("")}
                                        </div>
                                    </div>
                                </div>
                            `);
									} else {
										logsContent.push(`
                                <div class="card mb-3">
                                    <div class="card-header">${logName}</div>
                                    <div class="card-body">
                                        <p class="mb-0">No log entries available</p>
                                    </div>
                                </div>
                            `);
									}
								}
							} else {
								logsContent.push(`
                        <div class="alert alert-info">
                            No server logs were retrieved or accessible.
                        </div>
                    `);
							}

							serverLogs.innerHTML =
								logsContent.join(
									""
								);
						} catch (error) {
							console.error(
								"Error rendering server logs:",
								error
							);
							serverLogs.innerHTML = `
                <div class="alert alert-danger">
                    <strong>Error rendering server logs</strong><br>
                    ${error.message}
                </div>
            `;
						}

						// Diagnostic logs
						const diagnosticLogs =
							document.getElementById(
								"diagnostic-logs"
							);
						try {
							if (
								data.diagnostic_log &&
								data
									.diagnostic_log
									.length >
									0
							) {
								diagnosticLogs.innerHTML =
									data.diagnostic_log
										.map(
											(
												log
											) => {
												// Determine log level
												let logClass =
													"log-info";
												if (
													log.includes(
														"[error]"
													)
												) {
													logClass =
														"log-error";
												} else if (
													log.includes(
														"[warning]"
													)
												) {
													logClass =
														"log-warning";
												} else if (
													log.includes(
														"Success"
													) ||
													log.includes(
														"OK"
													)
												) {
													logClass =
														"log-success";
												}

												return `<div class="${logClass}">${log}</div>`;
											}
										)
										.join(
											""
										);
							} else {
								diagnosticLogs.innerHTML =
									'<div class="log-warning">No diagnostic logs available</div>';
							}
						} catch (error) {
							console.error(
								"Error rendering diagnostic logs:",
								error
							);
							diagnosticLogs.innerHTML = `<div class="log-error">Error rendering logs: ${error.message}</div>`;
						}
					}

					// Initialize with a test
					console.log(
						'Diagnostics tool ready. Click "Run Diagnostics" to start.'
					);
				}
			);
		</script>
	</body>
</html>
